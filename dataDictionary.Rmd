---
title: "Data Dictionary"
subtitle: "Whats in your DHIS2?"
version: "0.91"
output: 

  html_document:
    css: custom.css
    # toc: TRUE
    # toc_float: TRUE
    toc_depth: 4
    code_folding: hide
    fig_caption: TRUE
    self_contained: TRUE
    # template: html_template.html 
    
runtime: shiny
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE)


# source('dhis2_functions.R')

library( knitr )
library( tidyverse )
library( rlang )
library( stringi )
library( tidyselect )
library( jsonlite )
library( httr )
library( curl )
library( assertthat )
library( rlang )
library( stringi )
library( DT )

```

```{r helper_function}

# Login ####
loginDHIS2<-function( baseurl, username, password) {
  
  url<-paste0( baseurl, "api/me" )
  
  r <-  GET( url, authenticate(username, password) ) 
    
  assert_that( r$status_code == 200L ) 
}

# JSON helper function ####
## gets json text from url and converts to data frame 
get = function( source_url , .print = TRUE , ...){
    
    if ( .print ) print( paste( "downloading from" , source_url , "...") )
    
    from_url =  GET( source_url ) 
    
    if ( from_url$status_code != 200 ) return( FALSE )
    
    g = fromJSON( 
        
        suppressMessages( content( from_url , "text") ) 
    )
    
    return( g )
    
}

```

# {.tabset .tabset-fade}
 
## Login

1. Enter the url for the DHIS2 instance.  For example, for the 'stable' demo at https://play.dhis2.org/, the url is https://play.dhis2.org/2.32.0/dhis-web-dashboard/#/ (on July 3, 2019.  It may change...).   

2. Enter the user login.  For the example above:  admin

3. Enter the user password.  For the example above:  district

None of the three entries above are stored permanently; once the user's web-session is over the values are deleted from the server.  

```{r credentials, echo=FALSE}
inputPanel(
    
  textInput("baseurl", label = "DHIS2 URL:", NULL ), # "https://play.dhis2.org/2.28/"
  
  textInput("username", label = "User name:", NULL ), # "admin"
  
  passwordInput("password", label = "Password:", NULL ), # "district"
  
  checkboxInput("demo", label = "Test: use dhis2 demo", FALSE )
)


observe({
  req( input$demo )
  if ( input$demo ){
    
    updateTextInput( session, "baseurl" , value = "https://play.dhis2.org/2.28/" )
    updateTextInput( session, "username" , value = "admin" )
    updateTextInput( session, "password" , value = "district" )
  }
})

baseurl = reactive({
        # if url is from login or dashboard url, trimto get baseurl
       # possible.suffixes:
       suffix.part = "dhis-web"
       
       strsplit( input$baseurl, suffix.part)[[1]][1]

})

login = reactive({ 
  
      req( baseurl() )
      baseurl = baseurl()
      
      if ( is_empty( baseurl() ) | is_empty( input$username ) | is_empty( input$password ) ) return( FALSE )
  
      login = try( loginDHIS2( baseurl , input$username, input$password) )
      if ( class( login ) == "logical" ) return( login ) 
      return( FALSE )
    })

# renderText({  
#   req( baseurl() ) 
#   paste( baseurl()  , input$username, input$password )
#   })

```


System Information:

```{r}

system.info = reactive({
     req( login() )
     if ( login() ){
        # there are a couple forms of metadata in the api.  This code tests the format, then gets metadata
        # if available, use resources method
       
        url = paste0( baseurl() , "api/system/info" )
        getInfo = GET( url )
        getInfo.content =  content( getInfo , "text")
        info =   jsonlite::fromJSON( getInfo.content ) %>% 
          as_tibble() %>%
          filter( row_number() == 1 ) %>%
          select( version, buildTime  ,
                  lastAnalyticsTableSuccess ,
                  intervalSinceLastAnalyticsTableSuccess ,
                  lastAnalyticsTableRuntime ,
                  calendar, dateFormat )
     } else { NA }
}) 

renderText({  
  req( baseurl() ) 
  # req( login() )
  paste0( baseurl() , "api/system/info" , "  LOGIN:", login() )
  })

conditionalPanel(condition="$('html').hasClass('shiny-busy')",
                          tags$div("Loading...",id="loadmessage")
         ) 

renderTable( 
  
    if( !is.data.frame( system.info()) & nrow(system.info())>10 ){ data_frame() 
    } else { 
      system.info() 
      }
    
    , striped = TRUE , spacing = 's'

)

```

##  Available Metadata 

- The href column lists a url (e.g. https://play.dhis2.org/2.28/api/categories) that will returns a short list of information for each attribute. 

- Appending '?fields=:all&paging=false' (e.g. https://play.dhis2.org/2.28/api/categories?fields=:all&paging=false) to the url will provide all available information for that attribute. 

```{r resources  }
resources = reactive({
 
     if ( login() ){
        # there are a couple forms of metadata in the api.  This code tests the format, then gets metadata
        # if available, use resources method
       
        url = paste0( baseurl() , "api" )
        resources =  get( url )[['resources']]  %>% as_tibble() %>%
          arrange( displayName )
     }
}) 

conditionalPanel(condition="$('html').hasClass('shiny-busy')",
                          tags$div("Loading...",id="loadmessage")
         ) 

renderTable( 
    
    resources() %>% select( displayName, href ) %>% rename( Attribute = displayName ),
    striped = TRUE , spacing = 's' 

)
```

## All Data Elements 

```{r all_data_elements }

conditionalPanel(condition="$('html').hasClass('shiny-busy')",
                          tags$div("Loading...",id="loadmessage")
         ) 


dataElements = reactive({
        
    if (  login() ){
    
    # there are a couple forms of metadata in the api.  This code tests the format, then gets metadata
    # if available, use resources method
    url<-paste0( baseurl() ,"api/dataElements.json?fields=:all&paging=false")
    cols = c( 'id', 'name', 'shortName' , 'displayName', 'displayShortName' , 'categoryCombo' ,
              'zeroIsSignificant' )
    dataElements =  get( url )[[1]] %>% select( !!cols ) 
    
    } else { "Unable to login to server" }
}) 

dataElementGroups = reactive({
        
    if (  login() ){
    
    # there are a couple forms of metadata in the api.  This code tests the format, then gets metadata
    # if available, use resources method
    url<-paste0( baseurl() , "api/dataElementGroups.json?fields=:all&paging=false")
    cols = c( 'id', 'name' , 'dataElements' )
    dataElementGroups =  get( url )[[1]] %>% select( !!cols ) %>%
      rename( dataElementGroups.id = id , dataElementGroup = name )
    
    deg = map_df( 1:length( dataElementGroups$dataElementGroup) , 
                  ~merge( dataElementGroups[ .x, 1:2] ,
                              dataElementGroups$dataElements[[.x]] , all = T)
                          ) %>%
      rename( dataElement.id = id) %>%
      # collapse all dataElementGroups associated with a data element
      group_by(dataElement.id ) %>%
      summarise( 
                        dataElementGroup = paste( dataElementGroup, collapse = "\n")
                        )
    
    return( deg )
    
    } else { "Unable to login to server" }
}) 


dataSets = reactive({
        
    if (  login() ){
    
    # if available, use resources method
    url<-paste0( baseurl() , "api/dataSets.json?fields=:all&paging=false")
    cols = c( 'id', 'name' , 'dataSetElements'
              , 'periodType'
              )
    dataSets =  get( url )[[1]] %>% select( !!cols ) %>% 
      rename( dataSet.id = id, dataSet = name ) 
    
    } else { "Unable to login to server" }
}) 


categoryCombos = reactive({
        
    if (  login() ){
    
    # if available, use resources method
    url<-paste0( baseurl() , "api/categoryCombos.json?fields=:all&paging=false")
    cols = c( 'id', 'name'  )
    categoryCombos =  get( url )[[1]] %>% select( !!cols ) %>% 
      rename( categoryCombo.id = id, categoryCombo = name )
    
    } else { "Unable to login to server" }
}) 


categoryOptionCombos = reactive({
        
    if (  login() ){
    
    # if available, use resources method
    url<-paste0( baseurl() , "api/categoryOptionCombos.json?fields=:all&paging=false")
    cols = c( 'id', 'name',  'categoryCombo' )
    categoryOptionCombos =  get( url )[[1]] %>% 
      select( !!cols ) %>% 
      rename( categoryOptionCombo.id = id, categoryOptionCombo = name ) 
    
  coc = map_df( 1:length( categoryOptionCombos$categoryOptionCombo ),
                ~merge( categoryOptionCombos[.x , 1:2] ,
                        categoryOptionCombos$categoryCombo[.x, ] , all = T
                         )
                ) %>%
    rename( categoryCombo.id = y )

  
  categories = coc %>%
      inner_join( categoryCombos() ,
                  by = 'categoryCombo.id' ) %>%
      group_by( categoryCombo.id, categoryCombo ) %>%
      summarise(
        n_categoryOptions = n() ,
        Categories = paste( categoryOptionCombo , collapse = ' ;\n '  ) ,
        Category.ids = paste( categoryOptionCombo.id , collapse = ' ;\n '  )
      )
  
  return( categories )
 
    } else { "Unable to login to server" }
}) 

# renderTable( categoryOptionCombos() )


de.rows = reactive({ 
  req( dataElements() )
  de = dataElements()
  de.rows = nrow(de)
  paste( 'There are', de.rows , 'data elements' ) 
  
  })

renderText( de.rows() )

ds.rows = reactive({ 
  req( dataSets() )
  ds = dataSets()
  ds.rows = nrow(ds)
  paste( 'There are', ds.rows , 'data sets (forms) ' ) 
  
  })

renderText( ds.rows() )

cc.rows = reactive({ 
  req( categoryCombos() )
  cc = categoryCombos()
  cc.rows = nrow(cc)
  paste( 'There are', cc.rows , 'categoryCombos ' ) 
  
  })

renderText( cc.rows() )


```

```{r all_dsde }

# download button
 downloadHandler(filename = function() { 
    return(paste('dataDictionary', '.csv', sep=''))

 }, content = function(file) {
   write.csv( dataDictionary() , file)
 })


dataDictionary = reactive({
  
  req( dataElements() )
  req( dataSets() )
  req( categoryOptionCombos() )
  req( dataElementGroups() )
  
  de = dataElements()
  ds = dataSets()
  coc = categoryOptionCombos()
  deg = dataElementGroups()
  
  # create matrix of data elements within each dataset 
  # (info comes from dataset table, not data element table)
  
  dsde = map_df( 1:length( ds$dataSetElements), 
                 ~map_df( ds$dataSetElements[[.x]], 
                          ~as.matrix(.x) )) 
  
  dsde = dsde %>%
    rename( dataElement.id = dataElement ,
            dataSet.id = dataSet ,
            categoryCombo.id = categoryCombo ) %>%
    left_join( de %>% select( -categoryCombo ) ,
               by = c('dataElement.id' = 'id' )) %>%
    rename( dataElement = name ) %>%
    
    left_join( ds %>% select( dataSet.id, dataSet 
                              , periodType
                              ) ,
               by = 'dataSet.id' ) %>%
    
    left_join( coc, by = 'categoryCombo.id'  ) %>%
 
    left_join( deg , by = 'dataElement.id' )  %>%
    
    select( dataSet, dataElement, n_categoryOptions, Categories , dataElementGroup , zeroIsSignificant , 
            periodType ,
            dataElement.id, Category.ids , shortName , displayName, displayShortName )  %>%   
  
  # collapse all muliptle entries for each data element
  group_by( dataElement.id ) %>%
    summarise_all(
        list( ~paste( unique(.) , collapse = ';\n' ) )
        )
  
  
  # For versions <2.6, need to add categoryCombo
  # if ( !'categoryCombo' %in% names(dsde) ){
  #   categoryCombos =  tibble(
  #     dataSet =ds$dataSet ,
  #     categoryCombo = ds$categoryCombo$id )
  # 
  #   dsde = dsde %>% inner_join( cc,  by = "dataSet")
  # }
  
  return( dsde )
  
  })

DT::renderDataTable( 
    
    dataDictionary()  

)
```

## Malaria-relevant Data Elements 

<style>
.shiny-flow-layout>div {
  width: 100%;
}
</style>

```{r}

malaria_words =  as.character(expression( malaria , palu, Pf, plasmodi , attend , patient, consult , fever, fievre, ANC, CPN, IPT , TPI, RDT, TDR, rapid, slide, micro , imci, iccm, commun, CHW, chd, hsa,  village, VHW , death, dece, pop, census, recensement, ACT, ASAQ, AL, APT, SP, fansidar , artem , lufen , pyr , itn, llin, milda ) ) %>% paste( collapse = ', ')
  
not_malaria_words = as.character(expression( TB, tuberc, bcg, HIV , VIH, ART , PMTCT , malnut, yellow, typh , hemor, lass, polio, rabies, teanus, mening, LAL , plague, measles, diarr, bite, paralysis , cholera , trauma, cesar, urolo , amoxi ) ) %>% paste( collapse = ', ')
  
inputPanel(
    
  textInput("malaria_words", 
            "Malaria-relevant search terms", 
            malaria_words , width = '100%' ), 
  
  textInput("not_malaria_words", "exclude search terms" , 
            not_malaria_words , width = '100%'  )
  
)
  
 
```


```{r select_data_elements }

conditionalPanel(condition="$('html').hasClass('shiny-busy')",
                          tags$div( "Loading...", id = "loadmessage" )
         ) 

# download button
 downloadHandler(filename = function() { 
    return( paste('malariaDataDictionary', '.csv', sep=''))

 }, content = function(file) {
   write.csv( malariaDataDictionary() , file)
 })
 

malariaDataDictionary = reactive({
  
  req( dataDictionary() )
  
  mdd = dataDictionary()
  
  malaria_search_string = str_split( input$malaria_words , ",")[[1]] %>% 
    str_trim() %>%
    paste( collapse =  "|")
  
  not_malaria_search_string = str_split( input$not_malaria_words , ",")[[1]] %>% 
    str_trim() %>%
    paste0( collapse =  "|")
  
  
  ###  Complete the search ###  
  
  mal.de = grepl( malaria_search_string , 
                  mdd$dataElement , 
                  ignore.case = FALSE )
  
  not.mal.de = grepl( not_malaria_search_string , 
                  mdd$dataElement , 
                  ignore.case = TRUE )
 
  
  likely.de = mal.de & !not.mal.de

  return(  mdd[ likely.de , ] )
  
})


search.rows = reactive({ 
  
  req( malariaDataDictionary() )
  mdd.rows = nrow( malariaDataDictionary())
  paste( 'There are', mdd.rows , '(most likely) malaria relevant data elements' ) 
  })

renderText( search.rows() )

DT::renderDataTable( 
    
    malariaDataDictionary()  , 
    options = list( autoWidth = FALSE , scrollX = TRUE )

)
```


## Malaria-relevant Datasets (data entry forms)

```{r list_of_datasets}

conditionalPanel(condition="$('html').hasClass('shiny-busy')",
                          tags$div( "Loading...", id = "loadmessage" )
         ) 

datasetsInMalariaDictionary = reactive({
  
  req( malariaDataDictionary()   )
  
  datasets = malariaDataDictionary()  %>%
    select( dataSet , periodType ) %>% unique
  
  
})


# renderText( search.rows() )


DT::renderDataTable( 
    
    datasetsInMalariaDictionary()  , options = list(pageLength = 25)

)
```

## Malaria-relevant Indicators

```{r}

conditionalPanel(condition="$('html').hasClass('shiny-busy')",
                          tags$div( "Loading...", id = "loadmessage" )
         ) 

indicator_formula_translator = function( num_denom, id_names ){
  
  ids_between_braces = str_extract_all( num_denom , "\\{.*?\\}" )[[1]] %>% gsub("\\{|\\}", "", .)
  
  unique_ids = str_split( ids_between_braces , "\\.") %>% unlist %>% unique
  
  # lookup table 
  element_names = id_names %>% filter( id %in% unique_ids )
  
  # replace ids with names 
  for( .x in 1:nrow( element_names ) ){ 
    if ( .x ==1 ) text = num_denom 
    text = gsub( unique_ids[.x] , 
                 paste0( '[' , element_names[.x, 'name'], ']' ) ,
                 text, fixed = TRUE  ) 
  } 
  
  
  # trim braces and expand space around operators
  num_names = text %>%
    gsub( "\\{|\\}|\\#" , "", .) %>%
    gsub( "\\+" , " + " , . ) %>%
    gsub( "\\-" , " + " , . )
  
  return( num_names )
}


indicators = reactive({
        
    if (  login() ){
    
    # if available, use resources method
    url<-paste0( baseurl() ,"api/indicators.json?fields=:all&paging=false")
    cols = c( 'id', 'name' , 'displayName', 'description' , 'numerator' , 'denominator' ,
              'annualized'
              )
    indicators =  get( url )[[1]] %>% select( !!cols ) %>% 
      rename( indicators.id = id, indicator = name )
    
    } else { "Unable to login to server" }
}) 

indicators_translation = reactive({
  
  de = dataElements() %>%  select( id, name )
    
  url<-paste0( baseurl() , "api/categoryOptionCombos.json?fields=:all&paging=false")
  coc =  get( url )[[1]] %>% select( id, name ) 
  id_names = bind_rows( de , coc )
  
  ind = indicators() %>%
    mutate( numerator_label =  indicator_formula_translator( num_denom = numerator ,  id_names = id_names) ,
            denominator_label =  indicator_formula_translator( num_denom = denominator ,  id_names = id_names) 
    )
  
  return( ind )
  
})

indicator.rows = reactive({ 
  
  req( indicators() )
  ind.rows = nrow( indicators())
  paste( 'There are', ind.rows , 'indicators. ' ) 
  })

renderText( indicator.rows() )

```

The following indicators contain malaria-relevant data elements in their formulas

```{r}
DT::renderDataTable( 
    
    indicators_translation()  , options = list(pageLength = 25)

)
```



